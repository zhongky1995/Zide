# Zide 用户手册（当前实现版）

> 版本边界：基于仓库当前代码状态（2026-02-24）  
> 适用对象：内测用户、研发联调人员、运营验证人员  
> 覆盖范围：仅覆盖当前已实现并可调用的能力，不包含 PRD 中尚未落地的完整可视化界面与协作功能

## 产品概览

- 产品一句话定位：把长文生产拆成“项目-大纲-章节-检查-导出”的可追踪流程。
- 典型用户：
1. 需要快速产出方案/报告的内容生产者。
2. 负责验证 AI 写作链路的测试与运营同学。
3. 需要导出交付稿的项目负责人。
- 核心使用场景（3 条）：
1. 维护项目与章节，持续写作并更新状态。
2. 基于 AI 意图进行续写、扩写、重写、补论证、润色、简化。
3. 运行质量检查并导出 MD/HTML/PDF（当前 PDF 为兼容输出）。

## 快速开始

- 使用前准备：
1. 本机已安装 Node.js（建议 18+）与 npm。
2. 已执行 `npm install` 安装依赖。
3. 可在本地启动 Electron 开发模式。
4. 了解当前版本核心能力主要通过 `window.zide` API 调用（渲染层界面仍为占位页）。

- 第一步：启动应用
1. 终端 A 在项目根目录执行 `npm run dev:desktop`（启动 TypeScript watch + Vite）。
2. 终端 B 在项目根目录执行 `NODE_ENV=development npm start -w @zide/desktop`（启动 Electron）。
3. 若开发者工具未自动打开，手动按 `Cmd+Option+I`（macOS）打开。

- 第二步：验证 API 注入
1. 在 Console 输入 `window.zide`。
2. 确认能看到 `createProject`、`generateOutline`、`aiContinue`、`runCheck`、`exportProject` 等方法。

- 第三步：验证基础链路
1. 执行 `await window.zide.getProjects()`。
2. 返回结构应包含 `{ success: true, data: [...] }` 或 `{ success: false, error: '...' }`。

- 首次成功标准（用户如何确认已完成）：
1. 应用已启动且可调用 `window.zide`。
2. 任意 API 调用返回 JSON 结果（而不是 `undefined` 或执行报错）。

## 功能模块说明

### 项目与大纲管理

- 适用人群：项目创建者、内容负责人。
- 价值说明（一句话）：建立写作项目边界，并生成可维护的大纲结构。
- 前置条件：
1. 应用已启动并可使用 `window.zide`。
2. 已准备项目名称、类型、目标读者、规模等基础信息。
- 操作步骤：
1. 执行项目创建：  
   `await window.zide.createProject({ name: '示例项目', type: 'proposal', readers: '管理层', scale: '3万字', description: '项目说明' })`
2. 若创建成功，执行项目列表确认：  
   `await window.zide.getProjects()`
3. 使用项目 ID 生成大纲：  
   `await window.zide.generateOutline({ projectId, template: 'standard' })`
4. 按需维护大纲章节：  
   `await window.zide.addChapter(projectId, { title: '新章节', target: '写清楚价值' })`  
   `await window.zide.updateChapter(projectId, chapterId, { title: '章节新标题' })`  
   `await window.zide.confirmOutline(projectId)`
- 关键提示：
1. 当前版本存在已知问题：`createProject` 可能返回 `ENOENT`（项目目录与保存 ID 不一致）。内测时建议先使用预置项目目录。
2. `generateOutline` 只生成大纲文件，不会自动为每个大纲章节创建 `.md` 正文文件。
3. 当前 `addChapter` 会创建章节文件，但编号行为以当前文件状态为准。
- 结果反馈：
1. 成功时返回 `{ success: true, data: ... }`，`data` 中含 `projectId` 或 `outline`。
2. 失败时返回 `{ success: false, error: '错误信息' }`。
- 常见问题：
1. 问：为什么创建项目时报 `ENOENT`？
   答：当前实现存在已知缺陷。建议先使用预置项目进行后续流程，或由研发脚本初始化项目目录。
2. 问：为什么生成大纲后，`chapter:list` 仍然为空？
   答：大纲生成只写 `outline.md`，不会自动创建章节正文文件。需要通过 `addChapter` 或其他初始化方式创建章节文件。

### 章节写作与 AI 辅助

- 适用人群：内容撰写者、编辑人员。
- 价值说明（一句话）：对章节进行编辑与 AI 生成，提高写作推进效率。
- 前置条件：
1. 项目下至少已有一个章节文件（如 `01.md`）。
2. 已拿到可用 `chapterId`（通常来自 `getChapters` 返回的 `id`）。
- 操作步骤：
1. 获取章节列表与章节详情：  
   `await window.zide.getChapters(projectId)`  
   `await window.zide.getChapter(projectId, chapterId)`
2. 保存章节内容：  
   `await window.zide.saveChapter(projectId, chapterId, '# 章节标题\\n\\n正文内容')`
3. 触发 AI 意图：  
   `await window.zide.aiContinue(projectId, chapterId)`  
   `await window.zide.aiExpand(projectId, chapterId)`  
   `await window.zide.aiRewrite(projectId, chapterId)`
4. 查看并采纳操作历史：  
   `await window.zide.getOperationHistory(projectId, chapterId)`  
   `await window.zide.adoptOperation(projectId, chapterId, operationId)`
- 关键提示：
1. `continue/expand/addArgument` 会在原文后追加；`rewrite/polish/simplify` 会替换正文。
2. 当前 AI 为 `MockLLMAdapter`，输出是模板化内容，不代表真实生产模型效果。
3. 保存章节后会自动估算完成度（基于字数与结构），不是人工评审分。
- 结果反馈：
1. AI 接口成功后返回 `chapter` 与 `operation`，可直接用于审阅生成内容。
2. 章节更新后可在返回值中看到 `status`、`completion`、`operationCount` 变化。
- 常见问题：
1. 问：为什么 AI 输出风格很固定？
   答：当前接的是 mock 适配器，主要用于链路验证，不是线上真实模型。
2. 问：为什么完成度看起来不符合预期？
   答：当前完成度按规则估算（长度 + 简单结构），不等于人工质量评分。

### 上下文索引与检索

- 适用人群：需要提高 AI 生成一致性的用户。
- 价值说明（一句话）：为 AI 提供可追溯的上下文来源，减少跑题。
- 前置条件：
1. 章节已有可索引文本。
2. 项目元信息（`meta`、`outline`）存在。
- 操作步骤：
1. 手动索引章节：  
   `await window.zide.indexChapter(projectId, chapterId, content)`
2. 获取上下文包：  
   `await window.zide.packContext(projectId, chapterId)`
3. 按查询检索上下文：  
   `await window.zide.retrieveContext(projectId, chapterId, '关键词', 5)`
4. 查看索引统计并按需重建：  
   `await window.zide.getIndexStats(projectId)`  
   `await window.zide.rebuildIndex(projectId)`
- 关键提示：
1. 未索引或正文为空时，检索结果可能为空数组。
2. 索引文件会落到项目运行时目录的 `.index.json`。
3. `packContext` 会读取项目信息、术语表、大纲与相关切片来源。
- 结果反馈：
1. `packContext` 返回 `projectContext/relatedChapters/glossary/outline/sources`。
2. `getIndexStats` 返回 `totalChunks` 与 `indexedChapters`。
- 常见问题：
1. 问：为什么 `retrieveContext` 没结果？
   答：常见原因是章节未索引、章节正文过短或关键词与内容不匹配。
2. 问：为什么 `packContext` 里 `relatedChapters` 很少？
   答：当前为简单检索策略，且依赖已索引章节内容，建议先重建索引再重试。

### 质量检查

- 适用人群：需要在导出前做质量门禁的用户。
- 价值说明（一句话）：快速发现缺章、重复和低完成度章节。
- 前置条件：
1. 大纲与章节目录已存在。
2. 至少有部分章节已填写内容。
- 操作步骤：
1. 执行完整检查：  
   `await window.zide.runCheck(projectId)`
2. 分项检查：  
   `await window.zide.checkMissingChapters(projectId)`  
   `await window.zide.checkDuplicateContent(projectId)`  
   `await window.zide.checkCompletion(projectId, 30)`
3. 术语一致性与状态标记：  
   `await window.zide.checkTermConsistency(projectId)`  
   `await window.zide.resolveIssue(projectId, issue)`  
   `await window.zide.ignoreIssue(projectId, issue)`
- 关键提示：
1. 当前 `runCheck` 聚合的是缺章、重复、完成度检查。
2. `checkOutlineDrift` 当前返回空列表（能力尚未实现）。
3. `resolveIssue/ignoreIssue` 目前返回状态变更对象，未落盘持久化。
- 结果反馈：
1. 完整检查返回 `totalIssues/errors/warnings/infos/issues[]`。
2. 每条问题都包含 `type/severity/suggestion/status`。
- 常见问题：
1. 问：为什么完整检查里看不到术语冲突？
   答：术语一致性是单独接口，不在当前 `runCheck` 聚合范围内。
2. 问：为什么我“标记已解决”后再次检查又出现？
   答：当前状态标记未持久化，重新检查会按当前内容重新生成问题列表。

### 导出与交付

- 适用人群：需要提交文档成果的用户。
- 价值说明（一句话）：将章节内容合并为统一交付文件，支持多格式输出。
- 前置条件：
1. 项目下已有章节文件。
2. 章节内容已达到可交付质量。
- 操作步骤：
1. 导出整项目：  
   `await window.zide.exportProject(projectId, 'md')`  
   `await window.zide.exportProject(projectId, 'html')`  
   `await window.zide.exportProject(projectId, 'pdf')`
2. 导出指定章节：  
   `await window.zide.exportChapters(projectId, ['01', '02'], 'md')`
3. 预览与历史：  
   `await window.zide.exportPreview(projectId, 'html')`  
   `await window.zide.getExportHistory(projectId)`
4. 删除导出文件：  
   `await window.zide.deleteExport(filePath)`
- 关键提示：
1. 输出目录为项目运行时目录下的 `output/`。
2. 当前 `pdf` 导出为兼容实现，内容实际是 HTML 文本写入 `.pdf` 文件。
3. 导出内容会包含当前章节文件正文；若 frontmatter 清理不完整，可能一并输出。
- 结果反馈：
1. 成功返回 `filePath/fileSize/chapterCount/wordCount/createdAt`。
2. `getExportHistory` 返回 `recent` 列表和 `total`。
- 常见问题：
1. 问：为什么导出的 `final.pdf` 打不开或格式异常？
   答：当前实现是 HTML 兼容输出，尚未接入真实 PDF 渲染引擎。
2. 问：为什么导出正文里出现 `number/status` 等字段？
   答：章节解析目前会把部分 frontmatter 内容作为正文导出，需要在源章节中手动清理。

### 快照与回滚

- 适用人群：需要版本保护与回退的用户。
- 价值说明（一句话）：在关键改写前保存版本，减少误改风险。
- 前置条件：
1. 项目与章节文件存在。
2. 需要保留回滚点的关键操作前执行快照。
- 操作步骤：
1. 创建章节快照：  
   `await window.zide.createChapterSnapshot(projectId, chapterId)`
2. 创建全局快照：  
   `await window.zide.createGlobalSnapshot(projectId, '里程碑前备份')`
3. 查看快照：  
   `await window.zide.getSnapshots(projectId)`  
   `await window.zide.getLatestSnapshot(projectId, 'chapter')`
4. 尝试回滚：  
   `await window.zide.rollbackSnapshot(snapshotId)`  
   `await window.zide.rollbackChapter(projectId, chapterId)`
- 关键提示：
1. 当前版本“创建快照”可用。
2. 当前版本“按 ID 回滚”存在已知问题，可能返回 `Snapshot not found`。
3. 建议把快照作为留痕能力使用，回滚能力待后续修复后再作为主流程依赖。
- 结果反馈：
1. 快照创建成功返回 `snapshot.id/type/createdAt`。
2. 回滚失败时返回 `{ success: false, error: '...' }`。
- 常见问题：
1. 问：为什么快照明明创建成功，回滚却提示找不到？
   答：当前 `findById` 的项目定位逻辑有缺陷，导致按快照 ID 反查失败。
2. 问：快照会不会无限增长？
   答：系统会执行清理策略，默认每项目保留最近 50 条（可调用 `cleanupSnapshots`）。

### 统计与日志

- 适用人群：运营验证、质量追踪人员。
- 价值说明（一句话）：获取项目统计面板并记录关键操作日志。
- 前置条件：
1. 项目已存在。
2. 关键操作已通过 `logOperation` 写入日志（用于统计聚合）。
- 操作步骤：
1. 记录操作：  
   `await window.zide.logOperation({ projectId, operationType: 'export_run', status: 'success', duration: 1200 })`
2. 获取项目统计：  
   `await window.zide.getProjectMetrics(projectId)`
3. 获取全局统计：  
   `await window.zide.getGlobalMetrics()`
- 关键提示：
1. 统计数据依赖 `.logs/*.jsonl` 日志文件。
2. 当前章节字数统计存在已知偏差，`totalWords` 可能为 0。
3. `adoptedOperations` 依赖日志元数据，不会自动从章节操作文件反推。
- 结果反馈：
1. 返回内容含 `totalChapters/aiOperations/exportsCompleted/checksRun` 等指标。
2. 可用于阶段性验收与链路健康度观察。
- 常见问题：
1. 问：为什么 `totalWords` 总是 0？
   答：当前统计读取的是 `wordCount` 字段，而章节文件未持久化该字段。
2. 问：为什么 AI 采纳率不准确？
   答：采纳统计依赖操作日志中的 `metadata.adopted`，未统一写入时会偏低。

## 常见问题（FAQ）

### 我能不能像正式产品一样通过可视化页面完成全部操作？

- 症状：桌面窗口只有“项目骨架已创建，正在等待业务实现...”。
- 原因：当前渲染层仍是占位页，主流程能力主要在主进程 API。
- 解决步骤：
1. 使用开发者工具 Console 调用 `window.zide`。
2. 按本手册模块步骤执行项目/章节/导出操作。
3. 需要可视化交互时，等待后续 UI 迭代版本。

### 为什么项目创建失败，但其他接口看起来都在？

- 症状：`createProject` 返回 `success: false`，错误含 `ENOENT`。
- 原因：当前项目创建链路存在目录 ID 与保存 ID 不一致问题。
- 解决步骤：
1. 使用预置项目目录进行联调。
2. 先通过 `getProjects` 获取已有项目 ID。
3. 在已有项目上继续大纲、章节、导出流程。

### 为什么大纲与章节文件看起来“不同步”？

- 症状：大纲有章节条目，但章节列表为空或数量不一致。
- 原因：大纲生成与章节文件创建是两条独立链路。
- 解决步骤：
1. 使用 `addChapter` 创建实际章节文件。
2. 再用 `getChapters` 确认章节已落盘。
3. 对未落盘章节补建文件后再继续写作。

### 为什么导出结果里混入了元数据？

- 症状：导出文件出现 `status/completion/updatedAt` 等字段。
- 原因：章节解析与 frontmatter 边界处理仍较简化。
- 解决步骤：
1. 导出前先检查章节源文件结构。
2. 清理不希望进入正文的元数据段。
3. 再次执行导出并对比结果。

### 为什么快照能建不能回滚？

- 症状：`createChapterSnapshot` 成功，`rollbackSnapshot` 失败。
- 原因：快照 ID 反查逻辑存在已知缺陷。
- 解决步骤：
1. 继续使用快照作为版本留痕。
2. 重要改写前额外保留章节副本。
3. 回滚修复前避免把快照当唯一恢复手段。

## 故障排查

按“先易后难”执行：

1. 账号与权限检查  
   当前版本为本地单用户模式，无注册/登录/权限分层；此项可直接跳过。

2. 网络与设备检查  
   当前默认使用 mock AI，不依赖外网模型调用。若应用卡死，优先检查本机资源占用与 Electron 进程状态。

3. 页面状态与缓存检查  
   同时重启终端 A（`npm run dev:desktop`）和终端 B（`NODE_ENV=development npm start -w @zide/desktop`）；重新打开开发者工具，确认 `window.zide` 是否存在。

4. 数据一致性检查  
   核对项目运行时目录是否包含 `meta/outline/chapters/output/snapshots`；检查章节文件名与调用 `chapterId` 是否一致。

5. 联系支持前最小必要信息  
   准备以下信息后再提单：项目 ID、调用的 API 名称、请求参数、完整错误消息、操作时间（精确到分钟）、相关目录截图或日志片段。

## 术语表

- 项目（Project）：一次长文生产任务的最小管理单元，含元信息与章节集合。
- 大纲（Outline）：章节结构与章节目标定义文件，用于指导写作顺序。
- 章节（Chapter）：可独立编辑、生成与检查的正文单元。
- 章节 ID（chapterId）：章节接口调用标识，通常与章节文件名（不含 `.md`）一致。
- AI 意图（Intent）：生成动作类型，如续写、扩写、重写、补论证、润色、简化。
- 上下文包（Context Pack）：AI 调用前聚合的项目背景、相关章节、术语和大纲信息。
- 快照（Snapshot）：某一时刻的章节或全局版本留存记录。
- 检查问题（Check Issue）：质量检查发现的待处理项，如缺章、重复、低完成度。
- 导出任务（Export）：将章节合并为交付文件的执行过程。
- 操作日志（Operation Log）：记录关键动作状态、耗时和错误信息的结构化数据。
