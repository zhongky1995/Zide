# TODO｜稳定化开发计划（v2）

版本：v2.0  
日期：2026-02-26  
关联文档：`PRD.md`、`ARCHITECTURE.md`

---

## 当前阶段结论

项目不是“功能缺失”，而是“契约失配导致可见不可用”。  
本轮先以稳定性和前后端连通性为主线，按最小回滚粒度推进。

---

## 执行规则

1. 一次只推进一个可验证子目标，禁止跨模块混改。
2. 每次改动必须包含：构建验证 + 至少一个链路脚本验证。
3. 所有契约变更必须同步更新 `ARCHITECTURE.md`。
4. 同类问题连续 3 次修复失败，立即熔断并输出根因分析。

---

## Step List（新计划）

- [x] Step A1：打通核心可用链路（大纲 -> 章节 -> AI）
  - 范围：`FileOutlineRepo`、`ipc/outline.ts`、`renderer/App.tsx`
  - 验收：
    1. 生成大纲后 `chapters/` 下自动出现章节文件；
    2. 章节工作台可见章节并可进入编辑；
    3. AI 按钮可成功写入章节内容。
  - 完成日期：2026-02-26

- [x] Step A2：修复导出与快照关键断链
  - 范围：`export`/`snapshot` IPC + infrastructure 适配器
  - 验收：
    1. 导出格式值统一（`md|html|pdf`）；
    2. 导出历史可在前端正常渲染；
    3. 章节快照可成功回滚。
  - 完成日期：2026-02-26

- [x] Step A3：修复工程构建与测试基线
  - 范围：根脚本 `package.json`
  - 验收：
    1. 根 `build` 覆盖 `@zide/infrastructure`；
    2. 集成测试脚本不再递归死循环。
  - 完成日期：2026-02-26

- [x] Step B1：统一章节标识规范（`chapterId` vs `number`）
  - 范围：`outline/chapter/check/snapshot/export` 全链路
  - 目标：消除“文件名、大纲ID、路由ID”三套标识并存问题，避免后续排序/重排产生数据错位。
  - 验收：单一标识可贯穿 UI、IPC、存储、规则引擎。
  - 完成日期：2026-02-26
  - 完成说明：核心链路统一为数字章节 ID（如 `01`），并兼容历史 `ch-01` 输入；重排时同步重命名章节文件，避免编号与内容错位。

- [x] Step B2：补齐真实自动化测试（最小 E2E）
  - 范围：`tests/integration` + `tests/e2e`
  - 目标：把已修复链路固化成回归测试，防止再次退化。
  - 验收：
    1. 新建项目->生成大纲->AI续写->导出->快照回滚 全链路自动化；
    2. CI/本地一条命令可执行。
  - 完成日期：2026-02-26
  - 完成说明：新增 `scripts/test-integration-core-flow.js`，并将根脚本 `test:integration` 接入该回归链路。

- [x] Step B3：可观测性增强
  - 范围：`metrics` + 错误码体系
  - 目标：将“按钮无效”从用户感知问题转为可定位日志问题。
  - 验收：主要 IPC 失败均带错误码与上下文，前端提示可区分配置错误/数据错误/系统错误。
  - 完成日期：2026-02-26
  - 完成说明：
    1. 所有主 IPC 模块统一接入 `runIpc`，错误响应统一包含 `code + details`；
    2. 主进程新增 JSONL 日志，未捕获异常与 IPC 失败均落盘；
    3. 前端 API 层改为结构化错误事件，移除 `alert`，并在 UI 以分类 toast 呈现。

---

## 当前建议执行位

当前 A/B 阶段任务已全部完成，进入“维护与增量开发”阶段。  
后续新增功能应复用本轮统一契约（`runIpc` + 错误码 + 集成回归脚本）作为默认开发模板。
